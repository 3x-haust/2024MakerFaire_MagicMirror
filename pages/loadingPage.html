<!DOCTYPE html> 
<html lang="ko"> 
<head> 
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>마법의 거울 - 로딩</title> 
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>
  <div class="container"> 
    <img src="성 내부 사진.png" alt="Image 1"> 
    <img src="회오리.png" alt="Image 2" class="overlay">
    <h1 class="image_text" style="font-size: 100px;">당신의 전생은...</h1>
  </div>
  <div class="box"><div class="rectangle"></div></div>

  <script>
    async function processImage() {
      const dataURL = localStorage.getItem('capturedImage');
      if (!dataURL) {
        console.error('캡처된 이미지를 찾을 수 없습니다.');
        return;
      }

      try {
        await fetch('https://appandme.3xhaust.dev/picture/saveImage', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageUrl: dataURL }),
        });

        const lastNumber = await fetch('https://appandme.3xhaust.dev/picture/getLastImageNumber')
          .then(res => res.text());

        const imageUrl = `https://appandme.3xhaust.dev?id=${lastNumber}`;
        const blob = await fetch(imageUrl).then(res => res.blob());

        const formData = new FormData();
        formData.append('image', blob, `${lastNumber}.png`);
        const characterName = await fetch('https://appandme.3xhaust.dev/picture/generateCharacterName', {
          method: 'POST',
          body: formData,
        }).then(res => res.text());

        console.log(characterName);

        const stickerFormData = new FormData();
        stickerFormData.append('image', blob, `${lastNumber}.png`);
        stickerFormData.append('stickerNames', characterName.replace(/\n/g, ''));

        await fetch('https://appandme.3xhaust.dev/picture/applySticker', {
          method: 'POST',
          body: stickerFormData,
        })

        window.location.href = 'resultPage.html';
      } catch (error) {
        console.error('이미지 처리 실패:', error);
        //window.location.href = 'cameraPage.html';
      }
    }

    // 페이지 로드 시 이미지 처리 시작
    window.addEventListener('load', processImage);
  </script>
</body> 
</html>